# Whatâ€™s Improvement

## jsäº‹ä»¶å¾ªç¯æœºåˆ¶å’Œuiæ¸²æŸ“ | js/é¢è¯•

### äº‹ä»¶å¾ªç¯

ä»»åŠ¡é˜Ÿåˆ—
æ‰€æœ‰çš„ä»»åŠ¡å¯ä»¥åˆ†ä¸ºåŒæ­¥ä»»åŠ¡å’Œå¼‚æ­¥ä»»åŠ¡ï¼ŒåŒæ­¥ä»»åŠ¡ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯ç«‹å³æ‰§è¡Œçš„ä»»åŠ¡ï¼ŒåŒæ­¥ä»»åŠ¡ä¸€èˆ¬ä¼šç›´æ¥è¿›å…¥åˆ°ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œï¼›è€Œå¼‚æ­¥ä»»åŠ¡ï¼Œå°±æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ä»»åŠ¡ï¼Œæ¯”å¦‚ajaxç½‘ç»œè¯·æ±‚ï¼ŒsetTimeout å®šæ—¶å‡½æ•°ç­‰éƒ½å±äºå¼‚æ­¥ä»»åŠ¡ï¼Œå¼‚æ­¥ä»»åŠ¡ä¼šé€šè¿‡ä»»åŠ¡é˜Ÿåˆ—( Event Queue )çš„æœºåˆ¶æ¥è¿›è¡Œåè°ƒã€‚

åŒæ­¥å’Œå¼‚æ­¥ä»»åŠ¡åˆ†åˆ«è¿›å…¥ä¸åŒçš„æ‰§è¡Œç¯å¢ƒï¼ŒåŒæ­¥çš„è¿›å…¥ä¸»çº¿ç¨‹ï¼Œå³ä¸»æ‰§è¡Œæ ˆï¼Œå¼‚æ­¥çš„è¿›å…¥ Event Queue ã€‚ä¸»çº¿ç¨‹å†…çš„ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ä¸ºç©ºï¼Œä¼šå» Event Queue è¯»å–å¯¹åº”çš„ä»»åŠ¡ï¼Œæ¨å…¥ä¸»çº¿ç¨‹æ‰§è¡Œã€‚ ä¸Šè¿°è¿‡ç¨‹çš„ä¸æ–­é‡å¤å°±æ˜¯æˆ‘ä»¬è¯´çš„ Event Loop (äº‹ä»¶å¾ªç¯)ã€‚

åœ¨äº‹ä»¶å¾ªç¯ä¸­ï¼Œæ¯è¿›è¡Œä¸€æ¬¡å¾ªç¯æ“ä½œç§°ä¸º tickï¼Œé€šè¿‡é˜…è¯»è§„èŒƒå¯çŸ¥ï¼Œæ¯ä¸€æ¬¡ tick çš„ä»»åŠ¡å¤„ç†æ¨¡å‹æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œå…¶å…³é”®çš„æ­¥éª¤å¯ä»¥æ€»ç»“å¦‚ä¸‹ï¼š

1. åœ¨æ­¤æ¬¡ tick ä¸­é€‰æ‹©æœ€å…ˆè¿›å…¥é˜Ÿåˆ—çš„ä»»åŠ¡( oldest task )ï¼Œå¦‚æœæœ‰åˆ™æ‰§è¡Œ(ä¸€æ¬¡)
2. æ£€æŸ¥æ˜¯å¦å­˜åœ¨ Microtasks ï¼Œå¦‚æœå­˜åœ¨åˆ™ä¸åœåœ°æ‰§è¡Œï¼Œç›´è‡³æ¸…ç©ºMicrotask Queue
3. æ›´æ–° render
4. ä¸»çº¿ç¨‹é‡å¤æ‰§è¡Œä¸Šè¿°æ­¥éª¤

å¯ä»¥ç”¨ä¸€å¼ å›¾æ¥è¯´æ˜ä¸‹æµç¨‹ï¼š

![demopic1](/image/enevt_loop_1.jpg)

(macro)task ä¸»è¦åŒ…å«ï¼šscript( æ•´ä½“ä»£ç )ã€setTimeoutã€setIntervalã€I/Oã€UI äº¤äº’äº‹ä»¶ã€setImmediate(Node.js ç¯å¢ƒ)

microtask ä¸»è¦åŒ…å«ï¼šPromiseã€MutaionObserverã€process.nextTick(Node.js ç¯å¢ƒ)

> ç¤ºä¾‹ï¼š

```js
console.log('script start');

setTimeout(function() {
  console.log('setTimeout');
}, 0);

Promise.resolve().then(function() {
  console.log('promise1');
}).then(function() {
  console.log('promise2');
});

console.log('script end');
```

1. æ•´ä½“ script ä½œä¸ºç¬¬ä¸€ä¸ªå®ä»»åŠ¡è¿›å…¥ä¸»çº¿ç¨‹ï¼Œé‡åˆ° `console.log`ï¼Œè¾“å‡º `script start`
2. é‡åˆ° `setTimeout`ï¼Œå…¶å›è°ƒå‡½æ•°è¢«åˆ†å‘åˆ° `å®ä»»åŠ¡ Event Queue` ä¸­
3. é‡åˆ° `Promise`ï¼Œå…¶ thenå‡½æ•°è¢«åˆ†åˆ°åˆ° `å¾®ä»»åŠ¡ Event Queue` ä¸­,è®°ä¸º then1ï¼Œä¹‹ååˆé‡åˆ°äº† then å‡½æ•°ï¼Œå°†å…¶åˆ†åˆ°å¾®ä»»åŠ¡ Event Queue ä¸­ï¼Œè®°ä¸º then2
4. é‡åˆ° console.logï¼Œè¾“å‡º script end

è‡³æ­¤ï¼ŒEvent Queue ä¸­å­˜åœ¨ä¸‰ä¸ªä»»åŠ¡ï¼Œå¦‚ä¸‹è¡¨ï¼š

| å®ä»»åŠ¡  | å¾®ä»»åŠ¡ |
| ---------- | ------ |
| setTimeout | then1  |
| -          | then2  |

1. æ‰§è¡Œå¾®ä»»åŠ¡ï¼Œé¦–å…ˆæ‰§è¡Œthen1ï¼Œè¾“å‡º promise1, ç„¶åæ‰§è¡Œ then2ï¼Œè¾“å‡º promise2ï¼Œè¿™æ ·å°±æ¸…ç©ºäº†æ‰€æœ‰å¾®ä»»åŠ¡
2. æ­¤æ—¶ï¼Œæ‰€æœ‰çš„mircotaskæ‰§è¡Œå®Œæ¯•ï¼Œæœ¬è½®äº‹ä»¶å¾ªç¯ç»“æŸï¼ŒUI å¼€å§‹ renderï¼Œå½“ UI render å®Œæ¯•ï¼Œå¼€å§‹ä¸‹ä¸€è½®äº‹ä»¶å¾ªç¯.
3. æ‰§è¡Œ setTimeout ä»»åŠ¡ï¼Œè¾“å‡º setTimeout è‡³æ­¤ï¼Œè¾“å‡ºçš„é¡ºåºæ˜¯ï¼šscript start, script end, promise1, promise2, setTimeout

### UIæ¸²æŸ“

æ ¹æ®HTML Standardï¼Œä¸€è½®äº‹ä»¶å¾ªç¯æ‰§è¡Œç»“æŸä¹‹åï¼Œä¸‹è½®äº‹ä»¶å¾ªç¯æ‰§è¡Œä¹‹å‰å¼€å§‹è¿›è¡Œ ```UI render```ã€‚å³ï¼šmacro-taskä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œæ¥ç€æ‰§è¡Œå®Œæ‰€æœ‰çš„micro-taskä»»åŠ¡åï¼Œæ­¤æ—¶æœ¬è½®å¾ªç¯ç»“æŸï¼Œå¼€å§‹æ‰§è¡ŒUI renderã€‚UI renderå®Œæ¯•ä¹‹åæ¥ç€ä¸‹ä¸€è½®å¾ªç¯ã€‚

ğŸ’¬[æ·±å…¥ç†è§£JavaScriptäº‹ä»¶å¾ªç¯æœºåˆ¶](https://www.cnblogs.com/yugege/p/9598265.html) (åŸæ–‡)

ğŸ’¬[Javascriptäº‹ä»¶å¾ªç¯æœºåˆ¶ä»¥åŠæ¸²æŸ“å¼•æ“ä½•æ—¶æ¸²æŸ“UI](https://segmentfault.com/a/1190000013212944) (è¡¥å……ä¸æ¸²æŸ“UIç›¸å…³)

ğŸ’¬[ä»å¤šçº¿ç¨‹åˆ°Event Loopå…¨é¢æ¢³ç†](https://juejin.im/post/5d5b4c2df265da03dd3d73e5) (æ‰©å±•é˜…è¯»ï¼šé€šè¿‡ è¿›ç¨‹ã€çº¿ç¨‹ çš„è§’åº¦æ¥è§£é‡Šå•çº¿ç¨‹çš„JSä¸ºä»€ä¹ˆæ‹¥æœ‰ å¼‚æ­¥ çš„èƒ½åŠ›)
